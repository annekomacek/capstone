---
title: "Capstone"
author: "Anne Miller"
date: "April 1, 2023"
output:
  flexdashboard::flex_dashboard:
    horizontal_layout: fill
    vertical_layout: fill
runtime: shiny
resource_files:
- pic.jpeg
---



```{r, setup, include=FALSE}

#set working directory
knitr::opts_knit$set(root.dir='/Users/annek/Downloads/Capstone')

#load needed libraries
library(flexdashboard)
library(plotly)
library(sf)
library(tidyverse)
library(stringr)
library(dplyr)
library(ggplot2)
library(shiny)
library(urbnmapr)
library(shinydashboard)
library(formattable)
library(scales)
library(usmap)
library(rgl)
library(gt)
library(car)
library(vegan)
library(DescTools)
library(kableExtra)
library(scatterplot3d)
library(corrplot)
library(coin)
library(MASS)
library(PredPsych)

#load data
data <- read.csv(file = "Parks6.csv",header=T)
#remove unneeded columns
data <- data[,-c(2:4,33,36,43,47)]

```


```{r format-data}

#make factors factors
data[,2:28] <- lapply(data[,2:28],as.factor)

#standardize the data
#copy the health variables
data.standardized <- data.frame(data[,c(1,29:41)])
#scale the numeric variables
data.standardized[,2:14] <- data.frame(scale(data.standardized[,2:14]))
#copy data with the two positive health variables reserved
data.temp <- data.standardized
data.temp$PCPAdult <- data.temp$PCPAdult*-1
data.temp$PhysicalLeisure <- data.temp$PhysicalLeisure*-1
#create health rating
data.temp$HealthRating <- -1*(rowSums(data.temp[,2:14]))

#add health rating back into the standardized dataset
data.standardized <- cbind(data.standardized,HealthRating=data.temp$HealthRating)
#add health rating into total data frame
data <- cbind(data,HealthRating=data.temp$HealthRating)

#there are 62 observations and 27 predictors
#remove some predictors by grouping them together
data <- data%>%
  #combine all watersport amenities
  mutate(watersports=ifelse(Boat.Launch==1|Boat.Rentals==1|Canoe.Kayak==1|Stand.up.Paddle.Boarding==1|
                              Surfing.Windsurfing==1|Swimming.Beach==1|Swimming.Pool==1,1,0))%>%
  #combine all food amenities
  mutate(food.amenities=ifelse(Food==1|Grills==1,1,0))%>%
  #combine trails
  mutate(trails=ifelse(Biking==1|Equestrian.Trails==1|Hiking==1,1,0))%>%
  #combine field sports
  mutate(field.sports=ifelse(Disc.Golf==1|Playing.Fields==1,1,0))%>%
  #combine snow sports
  mutate(snow.sports=ifelse(Sledding==1|Snowmobiling==1|Snowshoeing.X.Country.Skiing==1,1,0))%>%
  #combine hunting and fishing
  mutate(hunting.fishing=ifelse(Hunting==1|Fishing==1,1,0))%>%
  #combine info centers
  mutate(info.center=ifelse(Visitor.Center==1|Nature.Center==1,1,0))
#remove redundant columns
data <- data[,-c(3:5,7:15,18,20:27)]

#make new variables factors
data[,22:28] <- lapply(data[,22:28],as.factor)
#group binary variables together again
data <- data[, c(1:7,22:28,8:21)]

```

```{r transform-outcomes}

#create dataframe with transformed variables
manova.df <- data%>%
  #apply log transformations
  mutate(BingeDrink=log(BingeDrink))%>%
  mutate(Cardiovascular=log(Cardiovascular))%>%
  mutate(DiabetesAdult=log(DiabetesAdult))%>%
  mutate(ObeseAdult=log(ObeseAdult))
#remove variables that could not be made normal
manova.df <- manova.df[,-c(18,23:25,27)]
#change colnames to reflect transformations
colnames(manova.df)[c(1,15,17,20,21)] <- c('County','LogBingeDrink','LogCardiovascular','LogDiabetesAdult',
  'LogObeseAdult')

```


Introduction {data-orientation=rows}
====================

<div align="center"> <h1 align="center"> **Relationships Between Health Outcomes and State Park Amenities in Counties in New York State: 2020-2021 Data** </h3> </div>

<br />

<div align="center"> <h2 align="center"> By Anne Miller </h2> </div>

<br />
<br />
<br />

<div align="center"> <h2 align="center"> **Question 1:**	Do mean health outcomes change based on the state park amenities available and, if so, what is the magnitude and direction of the relationship(s)? 
<br />
<br />
**Question 2:**	Does that relationship vary between groups of counties with different ranges of health outcomes and, if so, what is the magnitude and direction of the relationship(s) within each group?  </h2> </div>



Outcomes {data-orientation=rows data-navmenu='Data Used'}
====================

<div align="center"> <h2 align="center"> Health Outcome Variables Used in the Analysis </h2> </div>

<div align="center"> <h3 align="center"> As reported by www.data.ny.gov for the years 2020 or 2021 </h3> </div>

Row 1
-------------


```{r show-data}

#create dataframe of data explanations
outcome.data <- as.data.frame(cbind(c('Binge Drink','Buprenorphine','Cardiovascular',
                                      'Cardiovascular Hospital',
                                      'Cigarette','Depression','Adult Diabetes','Adult Obesity',
                                      'Child Obesity','Opiod Overdose','Regular Healthcare',
                                      'Adult Physical Leisure','Suicide'),
            c('Age-adjusted percentage of adults who report binge drinking within the last month',
            'Age-adjusted percentage of individuals who received one or more buprenorphine prescription for opioid use disorder',
              'Percentage of adults diagnosed with cardiovascular disease',
              'Age-adjusted percentage of cardiovascular disease hospitalizations','Percentage of adults who smoke cigarettes',
             'Percentage of adults diagnosed with depression',
                  'Age-adjusted percentage of adults diagnosed with diabetes','Percentage of obese adults (ages 18-64)',
                  'Percentage of obese children and adolescents (ages 0-17)','Age-adjusted percentage of opiod overdose deaths',
                  'Age-adjusted percentage of adults who have a regular healthcare provider',
                  'Percentage of adults (ages 18-64) who participate in leisure physical activity',
                  'Age-adjusted percentage of suicide mortalities'),
                  c('Prevention Agenda 2019-2024 Tracking Indicators',
                  'Prevention Agenda 2019-2024 Tracking Indicators',
                  'Community Health Indicator Reports (CHIRS)',
                  'Community Health Indicator Reports (CHIRS)',
                  'Prevention Agenda 2019-2024 Tracking Indicators',
                  'Behavioral Risk Factor Surveillance System (BRFSS)',
                  'Community Health Indicator Reports (CHIRS)',
                  rep('Prevention Agenda 2019-2024 Tracking Indicators',6))))

#remove colnames
colnames(outcome.data) <- NULL
#display as kable
outcome.data%>%kable%>%row_spec(c(1,3,5,7,9,11,13),background="#EDF6FF")%>%
  column_spec(1,bold=T)%>%
  kable_styling(latex_options = "striped")%>%
  add_header_above(c('Variable Name'=1,'Description'=1,'Source'=1),
                   font_size = 22,align='l')


```


Predictors {data-orientation=rows data-navmenu='Data Used'}
====================

<div align="center"> <h2 align="center"> Park Amenity Variables Used in the Analysis </h2> </div>

<div align="center"> <h3 align="center"> As reported by www.parks.ny.gov for the years 2020 or 2021 </h3> </div>

Row 1
-------------


```{r amenity-vars-explained}

#create dataframe of amenity variables' description
amenity.data <- as.data.frame(cbind(c('Pets','Camping','Pavillions','Playgrounds','Showers',
                                      'Waterfalls','Watersports','Food Amenities','Trails',
                                      'Field Sports','Snow Sports','Hunting/Fishing',
                                      'Information Centers'),
            c('No pets allowed',
              'No camping allowed in the park',
            'Park does not have pavillions',
                  'Park does not have any playgrounds',
                  'Park does have not showers',
                  'No waterfalls in the park',
                  'No watersports in the park',
            'Park has no food amenities',
            'Park does not have trails',
            'Park does not have field sports',
            'Park does not have snow sports',
            'No hunting or fishing allowed at the park',
            'No information centers at the park'),
            c(
            'Pets are allowed in the park',
              'Camping is allowed in the park',
             'Park has pavillions','Park has at least one playground','Park has showers',
                  'At least one waterfall in the park',
            'Park has at least one of the following: boat launch, boat rental, canoeing/kayaking, 
            
            \n stand-up paddle boarding, surfing/windsurfing, swimming beach, swimming pool',
            'Park has at least one of the following: food available for purchase, grills',
            'Park has at least one of the following: biking trail(s), equestrian trail(s), hiking trail(s)',
            'Park has disc golf and/or playing fields',
            'Park has at least one of the following: sledding, snowmobiling, snowshoeing/cross-country skiing',
            'Park alows hunting and/or fishing',
            'Park has visitor center(s) and/or nature center(s)')))

#remove colnames
colnames(amenity.data) <- NULL
#display as kable
amenity.data%>%kable%>%row_spec(c(1,3,5,7,9,11,13),background="#EDF6FF")%>%
  column_spec(1,bold=T)%>%
  kable_styling(latex_options = "striped")%>%
  add_header_above(c('Variable Name'=1,'0'=1,'1'=1),font_size = 22,align='l')


```


Health Outcomes by County {data-orientation=rows}
======================

<div align="center"> <h2 align="center"> Health Outcomes in New York (as reported by www.health.ny.gov for the years 2020 and 2021) </h2> </div>

-----------


```{r county-outcomes-plot-setup}

#create df with counties and outcomes
county.df <- data[,c(1,15:28)]
#change colname of "county" column to match that of the map data
colnames(county.df)[1] <- 'county_name'

#create variable with county shape files
counties <- get_urbn_map("counties", sf = TRUE)

#filter the data to get just NY data
counties <- counties %>% 
  filter(state_abbv == "NY")

#transform the data
counties <- counties %>% 
  st_transform("EPSG:32116")

#remove the "county" part of the county names
counties1 <- counties %>% 
  separate(county_name, c("county_name", "county"), sep = " County")

#order both dataframes alphabetically by county
counties1 <- counties1 %>% arrange(county_name)
county.df <- county.df %>% arrange(county_name)

#combine dataframes
county.df1 <- counties1 %>%
  left_join(
    county.df,
    by = 'county_name'
  )

```

Row 1 {data-height=100}
------------------

###

```{r county-outcomes-plot-input}

#get user input
radioButtons(
  inputId='outcome',
  label='Select a Health Outcome:',
  choices = colnames(county.df)[-1],
  inline=T
  )

```

Row 2
---------------

### {data-width=200}

<br />
<br />
<br />
<br />
<br />
<br /> 
  
  
Key:

+ Children are individuals aged 0-17
+ Adults are individuals aged 18-64
+ Buprenorphine is an FDA approved medication used in the treatment of opioid use disorder.
+ `Health Rating` is an overall health outcome score based on standardized values for all health outcomes for a county. It represents how a county's overall health outcomes compare to the mean health outcomes statewide. 

###

```{r county-outcomes-plot}

#create the plot
renderPlotly({
  #create subset of data with user choice
  sub <- county.df%>%dplyr::select(county_name,input$outcome)
  #create title based on user choice
  title <- ifelse(input$outcome=='BingeDrink',
           'Age-Adjusted Percentage of Adults That Report Binge Drinking within the Past Month by County',
                  ifelse(input$outcome=='Buprenorphine',
                         'Age-Adjusted Percentage of Adults that Received a Buprenorphine Prescription for Opiod Use Disorder by County',
                  ifelse(input$outcome=='Cardiovascular',
          'Age-Adjusted Percentage of Adults Diagnosed with Cardiovascular Disease by County',ifelse(input$outcome=='CardioHospital',
                  'Age-Adusted Percentage of Hospitalizations Due to Cardiovascular Disease by County',
                  ifelse(input$outcome=='Cigarette','Percentage of Adults Who Smoke Cigarettes by County',ifelse(input$outcome=='Depression',
                  'Percentage of Adults Diagnosed with Depression by County',
                  ifelse(input$outcome=='DiabetesAdult',
                  'Age-Adjusted Percentage of Adults Diagnosed with Diabetes by County',
                  ifelse(input$outcome=='ObeseAdult','Percentage of Obese Adults by County',
                  ifelse(input$outcome=='ObeseChild',
                  'Percentage of Obese Children and Adolescents by County',
                  ifelse(input$outcome=='OpiodOverdose','Age-Adjusted Percentage of Opiod Overdose Deaths by County',
                  ifelse(input$outcome=='PCPAdult','Age-Adjusted Percentage of Adults Who Have a Regular Healthcare Provider by County',
                         ifelse(input$outcome=='PhysicalLeisure','Percentage of Adults Who Participate in Physical Leisure by County',
                                ifelse(input$outcome=='Suicide',
                                       'Age-Adjusted Percentage of Suicide Mortality by County',
                                       'Overall Health Rating by County')))))))))))))
  #create the plot
         outcome.plot <- ggplot() +
           geom_sf(data = county.df1,
                   mapping = aes(fill = sub[,2]))+
           theme_minimal()+
           scale_fill_gradient2(
             #set the color gradient
             low = ifelse(input$outcome=='PCPAdult'|input$outcome=='PhysicalLeisure'|
                            input$outcome=='HealthRating','tomato','green4'),
             mid='yellow',
             high = ifelse(input$outcome=='PCPAdult'|input$outcome=='PhysicalLeisure'|
                             input$outcome=='HealthRating','green4','tomato'),
             midpoint=mean(sub[,2]))+
           labs(title = paste(title),
                fill=ifelse(input$outcome=='HealthRating','Rating','Percentage'))+
           theme(legend.title.align = 0.5,
                 plot.title = element_text(hjust = 0.5),
           axis.text.x = element_blank(),axis.text.y = element_blank(),rect = element_blank(),
           panel.grid.major = element_line(color = 'white'))


  #plot the map
  ggplotly(outcome.plot)
  
})

```



Amenities {data-orientation=rows}
======================
  
<div align="center"> <h2 align="center"> Park Amenities by County (as reported by www.parks.ny.gov in 2020 or 2021) </h2> </div>
  
----------
  
  
Row 1 {data-height=100}
------------------
  
###
  
```{r amenity-county-plot-input}

#get user input
radioButtons(
  inputId='amenity',
  label='Select an Amenity:',
  choices = colnames(data)[2:14],
  inline = T
)

#create dataframe of county data and amenities
county.amenity.df <- cbind(county.df,data[,2:14])

```

Row 2
---------------
  
###
  
```{r amenity-county-plot}


#amenity by county plot
renderPlotly({
  #create titles
  title.amenity.plot <- ifelse(input$amenity=='Pets',
                             'Counties with Parks that Allow Pets',
                             ifelse(input$amenity=='Camping',
                              'Counties with Parks that Allow Camping',
                             ifelse(input$amenity=='Pavillions',
                              'Counties with Parks that have Pavillions',
                             ifelse(input$amenity=='Playground',
                              'Counties with Parks that have Playgrounds',
                             ifelse(input$amenity=='Showers',
                              'Counties with Parks that have Showers',
                             ifelse(input$amenity=='Waterfalls',
                              'Counties with Parks that have Waterfalls',
                             ifelse(input$amenity=='watersports',
                              'Counties with Parks that have Watersports',
                             ifelse(input$amenity=='food.amenities',
                              'Counties with Parks that have Food and/or Grills',
                             ifelse(input$amenity=='trails',
                              'Counties with Parks that have Trails',
                             ifelse(input$amenity=='field.sports',
                              'Counties with Parks that have Field Sports',
                             ifelse(input$amenity=='snow.sports',
                              'Counties with Parks that have Snow Sports',
                             ifelse(input$amenity=='hunting.fishing',
                              'Counties with Parks that Allow Hunting and/or Fishing',
                              'Counties with Parks that have Information and/or Nature Centers'))))))))))))
  #create subset of data with user choice
  sub <- county.amenity.df%>%dplyr::select(county_name,input$amenity)
  #create plot
  amenity.plot <- sub%>%
    ggplot() +
    geom_sf(data = county.df1,
            mapping = aes(fill = sub[,2]))+
    theme_minimal()+
    scale_fill_manual(labels=c('No','Yes'),values=c('#2874A6','#61BEFC'))+
    labs(title = paste(title.amenity.plot),fill=colnames(sub)[2])+
    theme(legend.title.align = 0.5,
          plot.title = element_text(hjust = 0.5),
           axis.text.x = element_blank(),axis.text.y = element_blank(),
           panel.grid.major = element_line(color = 'white'))
  
  #display plot
  ggplotly(amenity.plot)
})

```





Health Outcomes vs. Amenities {data-orientation=cols}
======================
  
<div align="center"> <h2 align="center"> Differences in Overall Health Rating for 2020 and 2021 Based on Park Amenities Available in 2020 and 2021 </h2> </div>
  
-----------

The boxplots show the spread of the overall health rating within counties that do not have the amenity and counties that do. The lighter boxes represent the average overall health ratings in counties with the amenity, and the darker boxes represent the average overall health ratings in counties without it. A visible difference in median could imply an association between overall health rating and the park amenity shown. For example, the median health rating in counties with the following amenities appears slightly higher than the median health rating in counties without them: pets allowed, playgrounds, waterfalls, trails, and hunting and/or fishing. 

  
```{r, outcomes-v-amenities-plot, fig.show="hold", fig.dim=c(3.6,4.8)}

#create function to plot amenities
amenity.var.funct <- function(a.col){
  #create plot
  p <- ggplot(manova.df,(aes(HealthRating,fill=manova.df[,a.col])))+geom_boxplot()+
    theme_minimal()+
    scale_fill_manual(values=c('#2874A6','#61BEFC'),name='Amenity Availability',labels=c('No','Yes'))+
    ggtitle(colnames(manova.df)[a.col])+coord_flip()+
    theme(plot.title = element_text(hjust = 0.5))
  #display plot
  print(p)
}

#apply to all amenity variables
for(a.col in 2:13){
  amenity.var.funct(a.col)
}

```




Question 1 Defined {data-navmenu='Question 1'}
===========
  
  
<div align="center"> <h2 align="center"> **Question 1:	Do mean health outcomes change based on the state park amenities available and, if so, what is the magnitude and direction of the relationship(s)?** </h2> </div>
  
###
  
<div align="center"> <h3 align="center"> 
  
<br />
<br />
  
  
**Step 1: Check MANOVA/ANOVA assumptions**\   
<br />
- Multivariate Normality\
- Homogeneity of Variance\
- Independence\
- No multicollinearity\
- No outliers\   
<br />
*Variables remaining: Cardiovascular, Cigarette, Square Root-Transformed Depression, Log-Transformed Adult Obesity, Physical Leisure*
<br />
<br />
  **Step 2: Conduct MANOVA**\   
<br />
  - Post-hoc LDA\   
<br />
*MANOVA showed statistically significant evidence of an association between the above variables and playgrounds (p-value=0.04).*
<br />
<br />
  **Step 3: Conduct ANOVA**\   
<br />
  - Post-hoc Tukey-Kramer\
<br />
*ANOVA showed statistically significant evidence of an association between overall health rating and camping (p-value=0.03) and trails (p-value=0.01). \ Tukey-Kramer showed statistically significant evidence of an association between overall health rating and trails only (p-value=0.01).*

</h3> </div>



```{r normality-check-setup}

#run shapiro test for all data
#create vectors to hold results
shapiro.funct <- function(transform){
  #create vector to hold variables
  h.vars <- a.vars <- p.values0 <- p.values1 <- c()
  #iterate over all y's
  for(h.col in 15:27){
    #transform outcomes if requested
    if(transform=='log'){
      data[,h.col] <- log(data[,h.col])
    } else if (transform=='sqrt'){
      data[,h.col] <- sqrt(data[,h.col])
    } else if (transform=='cube'){
      data[,h.col] <- (data[,h.col])^1/3
    }
    #iterate over all x's
    for(a.col in 2:14){
      #conduct shapiro-wilk test
      test0 <- try(shapiro.test((data[,h.col][data[,a.col]==0])),silent=T)
      test1 <- try(shapiro.test((data[,h.col][data[,a.col]==1])),silent=T)
      if(class(test0)=='try-error'){
        p.values0 <- append(p.values0,NA)
      } else {p.values0 <- append(p.values0,round(test0$p.value,4))}
      if(class(test1)=='try-error'){
        p.values1 <- append(p.values1,NA)
      } else {p.values1 <- append(p.values1,round(test1$p.value,4))}
      #add results to vectors
      h.vars <- append(h.vars,colnames(data[h.col]))
      a.vars <- append(a.vars,colnames(data[a.col]))
    }
  }
  #combine results into a data frame
  results <- data.frame(cbind(Outcome=h.vars,Amenity=a.vars,Pvalue0=p.values0,Pvalue1=p.values1))
}

#create dataframes for each of the transformations to be used
#no transformation
transformed.results <- shapiro.funct('none')
transformed.results$transformation <- 'None'
#log transformation
log.results <- shapiro.funct('log')
log.results$transformation <- 'Log'
#sqrt transformation
sqrt.results <- shapiro.funct('sqrt')
sqrt.results$transformation <- 'Square Root'
#cube root transformation
cube.results <- shapiro.funct('cube')
cube.results$transformation <- 'Cube Root'


#combine them
results.full <- rbind(transformed.results,log.results,sqrt.results,cube.results)
#change colname
colnames(results.full) <- c('Outcome','Amenity','Pvalue0','Pvalue1','Transformation')
#convert pvalues to numeric
results.full$Pvalue0 <- as.numeric(results.full$Pvalue0)
results.full$Pvalue1 <- as.numeric(results.full$Pvalue1)

```




```{r normality-check-formatters}

#remove row names
row.names(results.full)=NULL

#create formatter to make value change color based on whether pvalue is high or low
pvalue.format=formatter("span", 
                        style = ~ style(font.size = "20px",color = ifelse(Pvalue1 < 0.05|Pvalue0<0.05, 
                                                                          "red", "black")))
#change background if either pvalue is NA
row.formatter <- formatter("span",style = ~style(font.size = "20px",display = "block", 
                                                 padding = "0 4px", `border-radius` = "4px", 
                                                 `background-color` = ifelse(Pvalue1==NaN|Pvalue1==NaN|Pvalue1==NA|Pvalue1==NA,"#C4C4C4",'white')))


```


MANOVA Assumptions Part 1 {data-orientation=rows data-navmenu='Question 1'}
====================
  
Row 1 {data-height=100}
------------
  
  
  
<div align="left"> <h2 align="left">  One assumption of MANOVA is normally distributed data at each combination of independent and dependent variables. </h2> </div>
  
Row 2
--------------
  
<div align="left"> <h4 align="left"> The table below shows each combination of outcome and amenity, with the p-value of a Shapiro-Wilk test for the distribution where the amenity is not present (Pvalue0) and the distribution where the amenity is present (Pvalue1). Red p-values indicate evidence of nonnormality (p-value<0.05). The variables that show no evidence of nonnormality are raw `Buprenorphine`, `Cigarette`, `Depression`, and `PhysicalLeisure` as well as log-transformed `BingeDrink`, `Cardiovascular`, `DiabetesAdult`, and `ObeseAdult`. </h4> </div>
  
------------
  
Row 2 {data-height=60}
---------------
  
``` {r normality-check-input}

#allow user to select transformation
radioButtons(
  inputId = "transformation",
  label = "Please Select a Transformation",
  choices =  c('None','Log','Square Root','Cube Root'),
  inline=T
)

```


Row 3
---------------
  
  
``` {r normality-check-table}

#create table using formatters and user selected transformation
renderFormattable(formattable(subset(results.full,Transformation==input$transformation),
                              align =c("c","c","c"),
                              list(
                                `Transformation`=F,
                                `Outcome`=row.formatter,
                                `Amenity`=row.formatter,
                                `Pvalue0`=pvalue.format,
                                `Pvalue1`=pvalue.format),row.names=F
))

```



MANOVA Assumptions Part 2 {data-orientation=columns data-navmenu='Question 1'}
====================
  

Col 1
------------

### 

<div align="center"> <h2 align="center"> Independence check: </h2> </div>

The results of `independence_test()` are displayed below. No p-values<0.05 indicate no statistically significant evidence of dependence among the response variables.


```{r independence-test}

#create empty vectors to hold results
h.vars <- pvalues <- c()
#iterate over each health outcome
for(h.col in c(15:22)){
  #save results of independence test of that outcome as a function of all amenity variables
  results <- try(independence_test(manova.df[,h.col]~Pets+Camping+Pavillions+Playground+Showers+Waterfalls+
                      watersports+food.amenities+trails+field.sports+snow.sports+
                      hunting.fishing+info.center,data=manova.df))
  #add results to vectors
  if(class(results)!='try-error'){
    h.vars <- append(h.vars,colnames(manova.df)[h.col])
    pvalues <- append(pvalues,round(pvalue(results)[1],4))
  }
}

#save results
independence.results <- as.data.frame(cbind(Outcome=h.vars,Pvalue=pvalues))
#display results
independence.results%>%kable%>%kable_styling(position = "center")

```


Col 2
------------

###

<div align="center"> <h2 align="center"> Outliers check: </h2> </div>

The results of `mahalanobis()` results below show 2 observations with a p-value<0.001. MANOVA will need to be conducted with and without these outliers to check for differences.


```{r outlier-check}

#calculate distances between points
mahalanobis.out <- mahalanobis(data[,c(15:22)],
   colMeans(data[,c(15:22)]),cov(data[,c(15:22)]))
#check for outliers based on p-value
pvalues <- round(pchisq(mahalanobis.out, df=3, lower.tail=FALSE),4)
#create data frame of outlier pvalues and corresponding counties
outlier.df <- data.frame(cbind(County=data$County,Pvalue=format(round(pvalues,10),scientific=F)))

#show results
outlier.df%>%kable%>%kable_styling(position='center')%>%
  row_spec(which(outlier.df$Pvalue<0.001), bold=T, color = "red")

```



MANOVA Assumptions Part 3 {data-orientation=rows data-navmenu='Question 1'}
====================
  

###

<div align="center"> <h2 align="center"> Multicollinearity check: </h2> </div>



The results of `cor()` are displayed below. The darkness of the background color corresponds with the magnitude of the correlation. None of the correlations are >=0.7, indicating no evidence of multicollinearity.



```{r multicollinearity-check}

#create formatter
cor.format <- formatter("span", 
                        style = x ~ style(font.size = "20px",color=ifelse(x==1,'white','black'),
                                          background = ifelse(abs(x)<0.2, 
                                                                          "#E8FCD8", ifelse(abs(x)<0.4,'#C6DDB4',
                                                                          ifelse(abs(x)<0.6,'#A6BF92',ifelse(abs(x)<0.8,'#8CAA76','#5B6F4B'))))))


#get results
cor.results <- as.data.frame(round(cor(manova.df[15:22]),3))
#display results
renderFormattable(formattable(cor.results,
                              align =c("c","c","c","c","c","c","c","c"),
                              list(
                                `LogBingeDrink`=cor.format,
                                `Buprenorphine`=cor.format,
                                `LogCardiovascular`=cor.format,
                                `Cigarette`=cor.format,
                                `Depression`=cor.format,
                                `LogDiabetesAdult`=cor.format,
                                `LogObeseAdult`=cor.format,
                                `PhysicalLeisure`=cor.format),
                              row.names=T
))

```



MANOVA Assumptions Part 4 {data-orientation=cols data-navmenu='Question 1'}
====================

Col 1
------------

###
  
<div align="center"> <h2 align="center"> Equal variance check: </h2> </div>

The table below shows a p-value testing the assumption of equal variance for each combination of predictor and response variable in the dataset. P-values shown in red indicate statistically significant evidence of unequal variance.
  
  
```{r variance-check-setup, max.height='100px'}

#create vectors to hold pvalues, amenities, and health outcomes
h.vars <- a.vars <- pvalues <- c()
#iterate over all health variables:
for(h.col in 15:22){
  #iterate over each amenity variable:
  for(a.col in 2:14){
    #test variance
    results <- leveneTest(manova.df[,h.col]~manova.df[,a.col])
    #save results
      h.vars <- append(h.vars,colnames(manova.df[h.col]))
      a.vars <- append(a.vars,colnames(manova.df[a.col]))
      pvalues <- append(pvalues,round(results$`Pr(>F)`[[1]],4))
  }
}

#combine results
levene.results <- data.frame(cbind(Outcome=h.vars,Amenity=a.vars,Pvalue=pvalues))

#show results
levene.results%>%kable%>%kable_styling(bootstrap_options = c("responsive"),position='center')%>%
  row_spec(which(levene.results$Pvalue<0.05), bold=T, color = "red")


```


Col 2
-----------

###

<div align="center"> <h2 align="center"> Sample size check: </h2> </div>

MANOVA is not extremely sensitive to violations of this assumption as long as the matrices are not too different and sample sizes are equal (the largest sample is less than 50% greater than the smaller sample). The table below shows of the three combinations with unequal variance, two combinations have unequal samples. Therefore, the assumption of equal variance is still not met.

```{r samp-size-check-table}

#create empty vector to hold equality results
approx.equal <- c()

#create function to check sample sizes of combinations with unequal variance
samp.size.funct <- function(h.cols,a.cols){
  for(index in 1:3){
    #calculate sample sizes
    results <- table(manova.df[,a.cols[index]])
    #save approx.equal results
    if((results[1]/results[2])>1.5|(results[2]/results[1])>1.5){
      approx.equal <- append(approx.equal,'No')
    } else {
      approx.equal <- append(approx.equal,'Yes')
    }
  }
  #combine results
  samp.size.results <- data.frame(cbind(Outcome=c('LogBingeDrink','LogBingeDrink','LogDiabetesAdult'),
                                  Amenity=c('field.sports','info.center','waterfalls'),
                                  Approximately.Equal=approx.equal))
  #return results
  return(samp.size.results)
}

#run function for each combination
samp.size.results <- samp.size.funct(c(15,15,20),c(11,14,7))

#create table
samp.size.results%>%kable%>%row_spec(c(2,3), background  = "yellow")%>%kable_styling(position = "center")

```

###

<br />

Although the assumption is not met, the size of each sample can provide insights into the results of the MANOVA test. Combinations where the larger sample also has the higher variance are robust to type I errors. For the combinations below, the first and third combinations have larger variance in the smaller sample. Therefore, we can be less confident about the MANOVA rejecting the null hypothesis for these combinations of predictor and response variables. Because of this, `LogBingeDrink` and `LogDiabetesAdult` are removed from the analysis

```{r samp.size2}

#create empty vectors
sample0 <- sample1 <- var0 <- var1 <- var.vec <- c()

#create function to find which sample is larger
samp.size.funct2 <- function(h.cols,a.cols){
  #iterate over each combination
  for(index in 1:3){
    #calculate sample sizes
    results <- table(manova.df[,a.cols[index]])
    #save the sample sizes
    sample0 <- append(sample0,results[[1]])
    sample1 <- append(sample1,results[[2]])
    #check variances of both samples
    var0 <- var(manova.df[manova.df[,a.cols[index]]==0,][,h.cols[index]])
    var1 <- var(manova.df[manova.df[,a.cols[index]]==1,][,h.cols[index]])
    #save the larger one
    var.vec <- append(var.vec,ifelse(var0>var1,0,1))
  }

  #combine results
  var.results <- data.frame(cbind(Outcome=c('LogBingeDrink','LogBingeDrink','LogDiabetesAdult'),
                                  Amenity=c('field.sports','info.center','waterfalls'),
                                  Sample.0=sample0,Sample.1=sample1,
                                  Larger.Variance=var.vec))
  #return results
  return(var.results)
}

#run function for each combination
var.results <- samp.size.funct2(c(15,15,20),c(11,14,7))

#create table
var.results%>%kable%>%row_spec(c(1,3), background  = "yellow")%>%kable_styling(position = "center")

```



```{r remove-vars}

#remove the variable with unequal covariance matrix and unequal samples
manova.df <- manova.df[,-c(15,20)]

```



MANOVA {data-orientation=columns data-navmenu='Question 1'}
====================
  
  
Col 1
--------------------

### {data-height=1000}

```{r MANOVA-funct}

#create MANOVA function
manova.funct <- function(data,h.cols){
  #create vector to hold dependent variables
  dependent.vars <- c()
  #iterate over all columns provided for health variables
  for(h.col in h.cols){
    #add each health variable to the dependent.vars variable
    dependent.vars <- cbind(dependent.vars,data[,h.col])
  }
  #fit MANOVA
  fit <- manova(dependent.vars~data$Pets+data$Camping+data$Pavillions+data$Playground+
                  data$Showers+data$watersports+data$Waterfalls+data$food.amenities+
                  data$trails+data$field.sports+data$snow.sports+data$hunting.fishing+
                  data$info.center,data=data)
  #display results
  return(fit)
}

#run the function for all health variables over all data
manova.full <- manova.funct(manova.df,c(15:20))
#save results as dataframe
manova.full.df <- as.data.frame(summary(manova.full)$stats)[-13,]
#capitalize column names
colnames(manova.full.df) <- c('DF','Pillai','F-statistic','Num DF','Den DF','P-value')
#make rownames the first column
manova.full.df$Variable <- rownames(manova.full.df)
#remove data$ from variables
manova.full.df$Variable <- gsub(".*\\$", "", manova.full.df$Variable)
rownames(manova.full.df) <- NULL
#move last column to first column
manova.full.df <- manova.full.df[,c(7,1:6)]
#round results
manova.full.df[,c(3,4,7)] <- round(manova.full.df[,c(3,4,7)],3)

#show results
manova.full.df%>%kable%>%kable_styling(position = "center")%>%row_spec(4,background='yellow')

```

###

The table above shows the results of a MANOVA test conducted on the response variables that fit the assumptions: `Buprenorphine`, `LogCardiovascular`,`Cigarette` `Depression`, `LogObeseAdult`, and `PhysicalLeisure.` Playgrounds has a p-value<0.05, indicating statistically significant evidence of a difference in health outcomes based on the availability of playgrounds.  


Col 2
----------

###

```{r manova-coeffs-full}

#create vector of dependent vars
dep.vars <- cbind(manova.df$Buprenorphine,manova.df$LogCardiovascular,manova.df$Cigarette,
                  manova.df$Depression,manova.df$LogObeseAdult,manova.df$PhysicalLeisure)


#get coefficients for manova with just significant variables
manova.coef <- manova(dep.vars~manova.df$Playground,data=manova.df)$coefficients

#save results
outcomes <- c('Buprenorphine','LogCardiovascular','Cigarette',
                  'Depression','LogObeseAdult','PhysicalLeisure')
coeffs <- c(manova.coef[2,][1],manova.coef[2,][2],manova.coef[2,][3],
            manova.coef[2,][4],manova.coef[2,][5],manova.coef[2,][6])
coeff.res <- as.data.frame(rbind(outcomes,
                                 round(coeffs,3)))
rownames(coeff.res) <- c('Outcomes','Coefficients')
colnames(coeff.res) <- NULL

#display results
coeff.res%>%kable%>%kable_styling(position = "center")%>%row_spec(1,bold=T)%>%
  column_spec(1,bold=T)


```

###

The  table above shows the coefficients of the MANOVA for playgrounds, the predictor variable that shows statistical evidence of a relationship with health outcomes. The coefficients  explain the difference in the expected mean of each health outcome when that variable is present versus when that variable is not present. For example, based on these results, it would be expected that the mean prevalence of adults who participate in physical leisure activities where playgrounds are present is about 0.764% greater than a county where playgrounds are not present.

###

```{r backtransform-logcardio}

#step 1 column
rawmean <- paste(round(mean(
  data[data$Playground==0,]$Cardiovascular),3),'%',sep='')
#step 2
logmean <- round(mean(manova.df$LogCardiovascular),2)
#coeffs
coeff <- -0.019
#step 3
logcoeff <- logmean+coeff
#step 4
backtransform.log <- paste(round(exp(logcoeff),2),'%',sep='')
#difference column
difference <- paste(round(as.numeric(str_sub(backtransform.log,end = -2))-as.numeric(str_sub(rawmean,end = -2)),2),'%',sep='')

# save results
log.back.res <- cbind('Raw Mean'=rawmean,'log','log(Mean)'=logmean,'$+$',
                      'log(Coefficient)'=coeff,'=',
                      'New log(Mean)'=logcoeff,'exp',
                      'New Raw Mean'=backtransform.log,
                      'Difference in Means'=difference)
#show results
log.back.res%>%kable%>%kable_styling(position='center')%>%
  column_spec(1,width='1.2cm',border_left=T,border_right=T)%>%
  column_spec(c(2,4,6,8),width='0.5cm')%>%
  column_spec(9,width='4cm',border_left=T)%>%
  column_spec(c(1,3,5,7),width='1.2cm')%>%
  row_spec(1,align='c')


```

###

Because cardiovascular was log-transformed, a back-transformation must be done in order to interpret the coefficient on the original scale. The table above shows each step done in the back-transformations. The first column displays raw mean percentage of adults diagnosed with cardiovascular disease in counties where playgrounds are not present. The second column is the log-transformed mean. The next column adds the MANOVA coefficients to the log-transformed means. The new log-transformed mean is shown and then back-transformed to the original scale by exponentiating it. The new mean on the original scale is shown, along with the difference in the original raw mean and the new back-transformed mean.



Post-Hoc LDA {data-orientation=rows data-navmenu='Question 1'}
====================

Row 1 {data-height=50}
-----------

### 

<div align="center"> <h2 align="center"> LDA Plot </h2> </div>

Row 2 {data-height=100}
-----------

###

Linear Discriminate Analysis (LDA) identifies combinations of the predictor variables that best separate the groups among the response variables. The first two combinations (LD1 and LD2) explain the largest amount of variance in the data. The values of these combinations are on each axis, and each point in the plot represents where each observation in the data is located among these values. The observations in teal have the chosen amenity, and the observations in red do not. The farther a point is from another point, the more those points differ. There does not appear to be any visible separation between the points within most of the groups, implying these groups may not differ much in regards to health outcome responses. Although playgrounds showed statistically significant evidence of a difference in health outcomes, LDA does not display a visible difference.


Row 3 
------------

### {data-width=200}
  
```{r manova-input}

#allow user to select an amenity
selectInput(inputId = "amenity1",
            label = "Please Select an Amenity",
            choices =  colnames(manova.df)[2:14])

```

### {data-width=900}

```{r lda}

renderPlotly({
  #create subset of data with user choice
  sub <- manova.df%>%dplyr::select(input$amenity1,Buprenorphine,LogCardiovascular,Cigarette,
                                   Depression,LogObeseAdult,PhysicalLeisure)
  lda.out <- lda(sub[,1]~dep.vars,CV=F,tol=0)
  #save predictions
  lda.df <- cbind(IndependentVariable=sub[,1],lda = predict(lda.out)$x)
  #create predictions plot
  lda.plot <- ggplot(data.frame(lda.df))+geom_point(aes(x = LD1, y = LD2, color = sub[,1]), size = 4) +
    theme_classic()+guides(color=guide_legend(title=colnames(sub)[1]))
  #display the plot
  ggplotly(lda.plot)

})

```



MANOVA Without Outliers {data-orientation=columns data-navmenu='Question 1'}
===============
  
  
Row 1 {data-width=300}
--------------------
  
### {data-height=800}
  

```{r manova-health-rating-no-outs}

#create subset without outliers
manova.data.no.outs <- manova.df[manova.df$County!='Seneca'& manova.df$County!='Bronx',]

#run the function for all health variables over all data
manova.no.outs <- manova.funct(manova.data.no.outs,c(15:20))
#save results as dataframe
manova.no.outs <- as.data.frame(summary(manova.full)$stats)[-13,]
#capitalize column names
colnames(manova.no.outs) <- c('DF','Pillai','F-statistic','Num DF','Den DF','P-value')
#make rownames the first column
manova.no.outs$Variable <- rownames(manova.no.outs)
#remove data$ from variables
manova.no.outs$Variable <- gsub(".*\\$", "", manova.no.outs$Variable)
rownames(manova.no.outs) <- NULL
#move last column to first column
manova.no.outs <- manova.no.outs[,c(7,1:6)]
#round manova.no.outs
manova.no.outs[,c(3,4,7)] <- round(manova.no.outs[,c(3,4,7)],3)

#show results
manova.no.outs%>%kable%>%kable_styling(position = "center")%>%row_spec(4,background='yellow')

```


###

The table above shows the results of a MANOVA conducted on the response variables that fit the assumptions: `Buprenorphine`, `LogCardiovascular`,`Cigarette` `Depression`, `LogObeseAdult`, and `PhysicalLeisure` when the two outliers are removed. The results are the same.  \

The Linear Discriminate Analysis (LDA) plot to the right shows the lack of separation between observations with the amenity (shown in teal) and those without (shown in red), minus the outlier observations. 


Col 2 
------------
  
  
```{r manova-input2}


#create vector of dependent vars
dep.vars2 <- cbind(manova.data.no.outs$Buprenorphine,manova.data.no.outs$LogCardiovascular,manova.data.no.outs$Cigarette,
                  manova.data.no.outs$Depression,manova.data.no.outs$LogObeseAdult,manova.data.no.outs$PhysicalLeisure)

#allow user to select an amenity
selectInput(inputId = "amenity2",
            label = "Please Select an Amenity",
            choices =  colnames(manova.data.no.outs)[2:14])

```

###

```{r lda2}

renderPlotly({
  #create subset of data with user choice
  sub <- manova.data.no.outs%>%dplyr::select(input$amenity2,Buprenorphine,LogCardiovascular,Cigarette,
                                   Depression,LogObeseAdult,PhysicalLeisure)
  lda.out <- lda(sub[,1]~dep.vars2,CV=F,tol=0)
  #save predictions
  lda.df <- cbind(IndependentVariable=sub[,1],lda = predict(lda.out)$x)
  #create predictions plot
  lda.plot <- ggplot(data.frame(lda.df))+geom_point(aes(x = LD1, y = LD2, color = sub[,1]), size = 4) +
    theme_classic()+guides(color=guide_legend(title=colnames(sub)[1]))
  #display the plot
  ggplotly(lda.plot)
})


```


ANOVA {data-orientation=rows data-navmenu='Question 1'}
====================
  
  
Row 1 {data-height=150}
---------
  
###

<div align="center"> <h2 align="center"> ANOVA of Health Rating </h2> </div>
  
  
Row 2 {data-height=150}
------------

###
  
<div align="center"> <h5 align="center"> The table below displays the results of an ANOVA conducted on all observations for overall health rating only. Independent variables that showed statistically significant evidence of association are highlighted in yellow. These results indicate two park amenities, camping and trails, may be associated with a change in overall health rating. </h5> </div>

Row 3 {data-height=800}
---------

###
  
```{r anova-health-rating}

#conduct ANOVA
anova.out.full <- aov(data$HealthRating~data$Pets+data$Camping+data$Pavillions+data$Playground+
                        data$Showers+data$Waterfalls+data$watersports+data$food.amenities+
                        data$trails+data$field.sports+data$snow.sports+data$hunting.fishing+
                        data$info.center,data=data)

#create dataframe of results
anova.full.df <- as.data.frame(cbind(colnames(manova.df)[c(2:12,14)],
                                     round(matrix(unlist(summary(anova.out.full)),ncol=5),3)[-13,]))
#capitalize column names
colnames(anova.full.df) <- c('Amenity','DF','Sum Sq','Mean Sq','F-statistic','P-value')

#show results
anova.full.df%>%kable%>%row_spec(c(2,9), background  = "lightyellow")%>%kable_styling(position = "center")

```

Row 4 {data-height=150}
---------
  
###

<div align="center"> <h2 align="center"> Post-Hoc Tukey-Kramer </h2> </div>
  
Row 5 {data-height=150}
------------
  
###

<div align="center"> <h5 align="center"> The table below displays the results of a Tukey-Kramer contrast that only includes the independent variables that were found to be significant in the ANOVA above. The Tukey-Kramer test controls for  family-wise error by adjusting p-values based on the number of comparisons made. The independent variables that showed statistically significant evidence of association via the Tukey-Kramer contrast are highlighted in yellow. </h5> </div>
  
  
  
Row 6 {data-height=280}
---------
  
###
  
```{r post-hoc-anova-funct}


#create empty vectors to hold results
diff <- lo <- hi <- p <- c()
#conduct Tukey
results <- TukeyHSD(aov(data$HealthRating~data$Camping+
                          data$trails,data=data))
#save results
for(each in 1:2){
  diff <- append(diff,round(results[[each]][1],3))
  lo <- append(lo,round(results[[each]][2],3))
  hi <- append(hi,round(results[[each]][3],3))
  p <- append(p,round(results[[each]][4],3))
}

#combine results
res <- as.data.frame(cbind(Amenity=c('Camping','Trails'),
                           Difference=diff,LowCI=lo,HiCI=hi,Pvalue=p))
#display results
res%>%kable%>%row_spec(2, background  = "yellow")%>%kable_styling(position = "center")

```


Question 1 Conclusion {data-orientation=rows data-navmenu='Question 1'}
====================
  

<br />
<br />
  
<div align="center"> <h1 align="center"> **Question 1 Conclusion:** </h1> </div>
  
<br />

  
<div align="center"> <h3 align="center"> **Question 1:	Do mean health outcomes change based on the state park amenities available and, if so, what is the magnitude and direction of the relationship(s)?** </h3> </div>

<br />
  
<div align="center"> <h4 align="center"> When all health outcomes are included (prevalence of buprenorphine prescriptions, cardiovascular diagnoses, cigarette useage, depression diagnoses, adult obesity, and adult physical leisure), there is statistically significant evidence of a difference in the mean of all health outcomes in a county based on availability of playgrounds in that county. \
<br />
<br />
There is statistically significant evidence of an estimated 4.557 difference in the mean overall health rating in a county when trails are available in that county versus when they are not (95% confidence interval 0.755-8.359, p-value=0.02). </h4> </div>
  
Question 2 Defined {data-orientation=rows data-navmenu='Question 2'}
====================
  
<div align="center"> <h2 align="center"> **Question 2:	Does the relationship between park amenities and health outcomes vary between groups of counties with different ranges of health outcomes and, if so, what is the magnitude and direction of the relationship(s) within each group?** </h2> </div>
  
###
  
<div align="center"> <h3 align="center"> 
  
<br />
<br />
  
**Step 1: Cluster observations based on health outcomes**\   
<br />
*This resulted in 3 groups of counties with health outcomes similar to each other and different from those in other groups.*
<br />
<br />
**Step 2: Check MANOVA/ANOVA assumptions**\   
<br />
- Multivariate Normality\
*Variables remaining: Cardiovascular Diagnoses, Square Root-Transformed Cigarette Usage, Depression, Childhood Obesity, and Adults with a Regular Health Provider*\
<br />
- Independence\
*All variables met this assumption all clusters*\
<br />
- Homogeneity of Variance\
- *Variables remaining: Square Root-Transformed Cigarette Usage, Childhood Obesity, and Adults with a Regular Health Provider*\
<br />
- No multicollinearity\
*All variables met this assumption all clusters*\
<br />
- No outliers\   
*All variables met this assumption within all clusters*

<br />
**Step 3: Conduct MANOVA**\   
<br />
- Post-hoc LDA\
<br />
*No associations in clusters 1 & 2*\
*Statistically significant assocation between health outcomes and waterfalls and food amenities in cluster 3*\
<br />
<br />
**Step 4: Conduct Nonparametric ANOVA**\   
<br />
- Post-hoc Tukey-Kramer\
<br />
*No statistically significant results*
<br />
<br />

</h3> </div>



Cluster the Data {data-orientation=columns data-navmenu='Question 2'}
====================
  
Col 1
------------
  
```{r cluster-data}

#set seed for reproducibility
set.seed(1)
#use 3 clusters
km.out <- kmeans(data.standardized[,2:14],3,nstart=1000)
#change ordering of clusters
clusters <- km.out$cluster
clusters[clusters==1] <- 'mid'
clusters[clusters==2] <- 1
clusters[clusters=='mid']=2
#add clusters to data
cluster.data <- cbind(data,cluster=as.factor(clusters))

```

###

```{r lowest-within-cluster-ss, fig.dim=c(6,6)}

#set value of B bootstrap repetitions and K clusters
B <- 1:50
K <- 2:10
#create vector to hold within cluster sum of squares
within.ss.vec <- c()
#set seed for reproducibility
set.seed(1)
#iterate through all K values
for(k in K){
  #iterate through all B values
  for(b in B){
    #create random sample from the rows of the data
    sample.indices <- sample(1:nrow(data.standardized),nrow(data.standardized),replace=T)
    #fit kmeans model
    km.out <- kmeans(data.standardized[,-c(1,15)][sample.indices,],centers=k,nstart=20)
    #store ss
    within.ss.vec <- append(within.ss.vec,mean(km.out$withinss))
  }
}

#find which k has smallest within cluster ss
average.within.ss <- apply(matrix(within.ss.vec,nrow=50),2,mean)
#create dataframe of results
within.ss.df <- data.frame(cbind(average.within.ss,K))

#plot the ss by k
ggplot(within.ss.df,aes(K,average.within.ss))+geom_line(linewidth=2)+geom_point(size=5)+
  labs(title='Within Cluster Sum of Squares',y='Within Cluster SS')

```

###  {data-height=150}

The plot above shows the within-cluster sum of squares based on the number of clusters. A larger number of clusters results in a lower sum of squares, meaning the more clusters they are, the more alike observations within each cluster are. 

### {data-height=150}


```{r cluster-input, a}

#allow user to choose number of clusters from k=2:14
sliderInput(inputId='cluster.n', label='Select a Number of Clusters: ', 1, 6, 
            value=1)

```


###  {data-height=150}

The slider above allows you to choose a number of clusters. The data is displayed in the plots on the right with the color of each observation indicating the cluster it is assigned to based on the slider input.

Col 2 
--------
  
  
### {data-height=350}
  
```{r 3d-cluster-plot}

#display plots
renderRglwidget({
#create the data with user chosen number of clusters
cluster.sub <- cluster.data%>%
  mutate(cluster=(kmeans(data.standardized[,2:14],input$cluster.n,nstart=1000)$cluster))%>%
  mutate(ID=(1:length(cluster.data[,1])))
#create function to create 3D plots with different health variables
try(close3d())

rgl.open(useNULL=T)
scatter3d(x=cluster.sub[,15], y=cluster.sub[,16], z=cluster.sub[,17],surface=F,
          point.col=as.numeric(cluster.sub$cluster),sphere.size=1.5,groups=as.factor(cluster.sub$cluster),
          xlab=colnames(cluster.sub[15]),
          ylab=colnames(cluster.sub[16]),
          zlab=colnames(cluster.sub[17]))
rglwidget()
})

```


### {data-height=350}

```{r 3d-cluster-plot2}

#display plots
renderRglwidget({
  #create the data with user chosen number of clusters
  cluster.sub <- cluster.data%>%
    mutate(cluster=(kmeans(data.standardized[,2:14],input$cluster.n,nstart=1000)$cluster))%>%
    mutate(ID=(1:length(cluster.data[,1])))
  #create function to create 3D plots with different health variables
  try(close3d())
  
  rgl.open(useNULL=T)
  scatter3d(x=cluster.sub[,18], y=cluster.sub[,19], z=cluster.sub[,20],surface=F,
            point.col=as.numeric(cluster.sub$cluster),sphere.size=1.5,groups=as.factor(cluster.sub$cluster),
            xlab=colnames(cluster.sub[18]),
            ylab=colnames(cluster.sub[19]),
            zlab=colnames(cluster.sub[20]))
  rglwidget()
})

```

Col 2 
-------------
  
### {data-height=350}
  
```{r 3d-cluster-plot3}

#display plots
renderRglwidget({
#create the data with user chosen number of clusters
cluster.sub <- cluster.data%>%
  mutate(cluster=(kmeans(data.standardized[,2:14],input$cluster.n,nstart=1000)$cluster))%>%
  mutate(ID=(1:length(cluster.data[,1])))
#create function to create 3D plots with different health variables
try(close3d())
  
rgl.open(useNULL=T)
scatter3d(x=cluster.sub[,21], y=cluster.sub[,22], z=cluster.sub[,23],surface=F,
            point.col=as.numeric(cluster.sub$cluster),sphere.size=1.5,groups=as.factor(cluster.sub$cluster),
            xlab=colnames(cluster.sub[21]),
            ylab=colnames(cluster.sub[22]),
            zlab=colnames(cluster.sub[23]))
rglwidget()
})

```


### {data-height=350}

```{r 3d-cluster-plot4}

#display plots
renderRglwidget({
  #create the data with user chosen number of clusters
  cluster.sub <- cluster.data%>%
    mutate(cluster=(kmeans(data.standardized[,2:14],input$cluster.n,nstart=1000)$cluster))%>%
    mutate(ID=(1:length(cluster.data[,1])))
  #create function to create 3D plots with different health variables
  try(close3d())
  
  rgl.open(useNULL=T)
  scatter3d(x=cluster.sub[,24], y=cluster.sub[,25], z=cluster.sub[,26],surface=F,
            point.col=as.numeric(cluster.sub$cluster),sphere.size=1.5,groups=as.factor(cluster.sub$cluster),
            xlab=colnames(cluster.sub[24]),
            ylab=colnames(cluster.sub[25]),
            zlab=colnames(cluster.sub[26]))
  rglwidget()
})

```



Group Variance {data-orientation=columns data-navmenu='Question 2'}
====================
  
<div align="center"> <h3 align="center"> The boxplots below show the distribution of overall health rating within each cluster. There is a visible difference in overall health rating between the clusters, with cluster 3 being lowest and cluster 2 being highest. While most plots show a relatively low mean overall health rating for cluster 3, most plots show that overall health rating is more or less equal within the other two clusters. </h3> </div>
  
  
```{r, cluster-variance-boxplots, fig.show="hold", fig.dim=c(5.25,3.5)}

#create function to view boxplots of within and between group variance for all amenities and health rating
boxplot.var.funct <- function(a.col){
  p <- ggplot(cluster.data,(aes(cluster,HealthRating,fill=cluster.data[,a.col])))+geom_boxplot()+
    guides(fill=guide_legend(title=colnames(cluster.data[a.col])))+
    labs(x='Cluster',y='Health Rating',
         title=colnames(cluster.data[a.col]))
  print(p)
}

#apply to all amenity variables
for(a.col in 2:13){
  boxplot.var.funct(a.col)
}

```



```{r normality-cluster-check, eval=F}

#create shapiro wilk function that will differentiate between clusters
cluster.shapiro.funct <- function(data,h.cols,a.cols,transform){
  #create vectors to hold results
  h.vars <- a.vars <- p.values0 <- p.values1 <- c()
  #iterate over all y's
  for(h.col in h.cols){
    #transform outcomes if requested
    if(transform=='log'){
    data[,h.col] <- log(data[,h.col])
    } else if (transform=='sqrt'){
          data[,h.col] <- sqrt(data[,h.col])
    } else if (transform=='cube'){
          data[,h.col] <- (data[,h.col])^1/3
      }
    #iterate over all x's
    for(a.col in a.cols){
      #iterate over each cluster
      for(c in 1:3){
        #conduct shapiro-wilk test
        data2 <- data[data$cluster==c,]
        test0 <- try(shapiro.test((data2[,h.col][data2[,a.col]==0])),silent=T)
        test1 <- try(shapiro.test((data2[,h.col][data2[,a.col]==1])),silent=T)
        if(class(test0)=='try-error'){
            p.values0 <- append(p.values0,NA)
        } else {p.values0 <- append(p.values0,round(test0$p.value,4))}
        if(class(test1)=='try-error'){
            p.values1 <- append(p.values1,NA)
        } else {p.values1 <- append(p.values1,round(test1$p.value,4))}
        #add results to vectors
        h.vars <- append(h.vars,colnames(data2[h.col]))
        a.vars <- append(a.vars,colnames(data2[a.col]))
      }
    }
  }
  #combine results into a data frame
  results <- data.frame(cbind(Cluster=c(rep(c(1:3),length(a.cols))),
                            Outcome=h.vars,Amenity=a.vars,Pvalue0=p.values0,Pvalue1=p.values1))
  #display results with conditional coloring based on p-value
  results %>% 
    mutate_all(~cell_spec(.x, color = ifelse(is.na(results$Pvalue0)|
                                               is.na(results$Pvalue1),'white',
                                             ifelse(results$Pvalue0 < 0.05|
                                               results$Pvalue1<0.05, "red"," black")),
        background = ifelse(is.na(results$Pvalue0)|
                                               is.na(results$Pvalue1), "grey"," white"))) %>%
    kable(escape = F) %>%
    kable_styling()
}

#run the function on cluster data
cluster.shapiro.funct(cluster.data,h.cols=c(15:28),a.cols=c(2:14),'none')

#try log transformation
cluster.shapiro.funct(data=cluster.data,h.cols=c(15,16,18,19,21,22,24,26),a.cols=c(2:14),transform='log')

#try sqrt transformation
cluster.shapiro.funct(cluster.data,h.cols=c(15,16,18,19,21,22,24,26),a.cols=c(2:14),transform='sqrt')

#try cube root transformation
cluster.shapiro.funct(cluster.data,h.cols=c(15,16,18,21,22,24,26),a.cols=c(2:14),
                            transform='cube')

```


```{r remove-cluster-vars}

#remove variables that could not be made normal
manova.cluster.df <- cluster.data[,-c(15,16,18,21,22,24,26,27)]
#transform variables
manova.cluster.df$Cigarette <- sqrt(manova.cluster.df$Cigarette)
#change colnames
colnames(manova.cluster.df)[c(16)] <- 'SqrtCigarette'

```


```{r independence-test-cluster, eval=F}

#iterate over each health outcome in clusters
for(h.col in c(15:19)){
  cat('Outcome:',colnames(manova.cluster.df[h.col]),'\n')
  #iterate over each cluster
  for(c in 1:3){
  cat('Cluster:',c,'\n')
  #save results of independence test of that outcome as a function of all amenity variables
  results <- try(independence_test(manova.cluster.df[manova.cluster.df$cluster==c,][,h.col]~
              Pets+Camping+Pavillions+Playground+Showers+Waterfalls+
                      watersports+food.amenities+trails+field.sports+snow.sports+
                      hunting.fishing+info.center,
              data=manova.cluster.df[manova.cluster.df$cluster==c,]))
  #display results
  print(results)
  }
}

```

```{r variance-check-cluster,eval=F}

#test variance at each combination of amenity and health variable
#create vectors to hold pvalues, amenities, and health outcomes
h.vars <- a.vars <- pvalues <- clusters <- c()
#iterate over all health variables:
for(h.col in 15:19){
  #iterate over each amenity variable:
  for(a.col in 2:14){
    #iterate over clusters
    for(c in c(1:3)){
      #test variance
      results <- try(leveneTest(manova.cluster.df[manova.cluster.df$cluster==c,][,h.col]~
                              manova.cluster.df[manova.cluster.df$cluster==c,][,a.col]))
      #save results if significant
      if(results$`Pr(>F)`[1]<0.05){
      h.vars <- append(h.vars,colnames(manova.cluster.df[h.col]))
      a.vars <- append(a.vars,colnames(manova.cluster.df[a.col]))
      pvalues <- append(pvalues,round(results$`Pr(>F)`[[1]],4))
      clusters <- append(clusters,c)
      }
    }
  }
}


#display results
print(cbind(Cluster=clusters,Outcome=h.vars,Amenity=a.vars,Pvalue=pvalues))

```


```{r equal-sample-test-clusters, eval=F}

#calculate sample sizes for cluster 1
results <- table(manova.cluster.df[manova.cluster.df$cluster==1,]$Playground)
#check if larger sample is >50% greater than smallest sample
((results[1]/results[2])>1.5|(results[2]/results[1])>1.5)

#calculate sample sizes
results <- table(manova.cluster.df[manova.cluster.df$cluster==1,]$Waterfalls)
#check if larger sample is >50% greater than smallest sample
((results[1]/results[2])>1.5|(results[2]/results[1])>1.5)

#calculate sample sizes
results <- table(manova.cluster.df[manova.cluster.df$cluster==1,]$field.sports)
#check if larger sample is >50% greater than smallest sample
((results[1]/results[2])>1.5|(results[2]/results[1])>1.5)

#calculate sample sizes for cluster 2
results <- table(manova.cluster.df[manova.cluster.df$cluster==2,]$Playground)
#check if larger sample is >50% greater than smallest sample
((results[1]/results[2])>1.5|(results[2]/results[1])>1.5)

results <- table(manova.cluster.df[manova.cluster.df$cluster==2,]$field.sports)
#check if larger sample is >50% greater than smallest sample
((results[1]/results[2])>1.5|(results[2]/results[1])>1.5)

results <- table(manova.cluster.df[manova.cluster.df$cluster==2,]$Waterfalls)
#check if larger sample is >50% greater than smallest sample
((results[1]/results[2])>1.5|(results[2]/results[1])>1.5)

```


```{r cluster-samp-size-,eval=F}

#create function to check sample sizes of combinations with unequal variance
samp.size.funct.clust <- function(data,h.cols,a.cols){
  #create empty vector to hold equality results
  approx.equal <- c()
  for(index in 1:length(h.cols)){
    #calculate sample sizes
    results <- table(data[,a.cols[index]])
    #save approx.equal results
    if((results[1]/results[2])>1.5|(results[2]/results[1])>1.5){
      approx.equal <- append(approx.equal,'No')
    } else {
      approx.equal <- append(approx.equal,'Yes')
    }
  }

  #return results
  return(approx.equal)
}

#cluster 1
samp.size.funct.clust(manova.cluster.df[manova.cluster.df$cluster==1,],c(15,15,15,16),c(5,7,11,7))
#cluster 2
samp.size.funct.clust(manova.cluster.df[manova.cluster.df$cluster==2,],c(15,15,17),c(5,11,7))

```


```{r sample-size2-cluster, eval=F}

#create function to find which sample is larger
samp.size.funct2.cluster <- function(data,h.cols,a.cols){
  #create empty vectors
  sample0 <- sample1 <- var0 <- var1 <- var.vec <- c()
  #iterate over each combination
  for(index in 1:length(a.cols)){
    #calculate sample sizes
    results <- table(data[,a.cols[index]])
    #save the sample sizes
    sample0 <- append(sample0,results[[1]])
    sample1 <- append(sample1,results[[2]])
    #check variances of both samples
    var0 <- var(data[data[,a.cols[index]]==0,][,h.cols[index]])
    var1 <- var(data[data[,a.cols[index]]==1,][,h.cols[index]])
    #save the larger one
    var.vec <- append(var.vec,ifelse(var0>var1,0,1))
  }

  #combine results
  var.results <- data.frame(cbind(Outcome=colnames(data)[c(h.cols)],
                                  Amenity=colnames(data)[c(a.cols)],
                                  Sample.0=sample0,Sample.1=sample1,
                                  Larger.Variance=var.vec))
  #return results
  return(var.results)
}

#cluster 1
samp.size.funct2.cluster(manova.cluster.df[manova.cluster.df$cluster==1,],c(15,15,15,16),c(5,7,11,7))
#sqrtcigarette robust to type 1
#cluster 2
samp.size.funct2.cluster(manova.cluster.df[manova.cluster.df$cluster==2,],c(15,15,17),c(5,11,7))

```

```{r remove-cluster-vars2}

#remove variables that do not have equal variance
manova.cluster.df <- manova.cluster.df[,-c(15,17)]

```

```{r cluster-collinearity,eval=F}
#check cluster 1
cor(manova.cluster.df[manova.cluster.df$cluster==1,c(15:17)])
#check cluster 2
cor(manova.cluster.df[manova.cluster.df$cluster==2,c(15:17)])
#check cluster 3
cor(manova.cluster.df[manova.cluster.df$cluster==3,c(15:17)])
```


```{r cluster-outliers, eval=F}

#calculate distances between points in cluster 1
mahalanobis.out1 <- mahalanobis(manova.cluster.df[manova.cluster.df$cluster==1,c(15:17)],
   colMeans(manova.cluster.df[manova.cluster.df$cluster==1,c(15:17)]),cov(manova.cluster.df[manova.cluster.df$cluster==1,c(15:17)]))
#check for outliers based on p-value
pvalues <- round(pchisq(mahalanobis.out1, df=3, lower.tail=FALSE),4)
#check for outliers
pvalues<0.001

#calculate distances between points in cluster 2
mahalanobis.out2 <- mahalanobis(manova.cluster.df[manova.cluster.df$cluster==2,c(15:17)],
   colMeans(manova.cluster.df[manova.cluster.df$cluster==2,c(15:17)]),cov(manova.cluster.df[manova.cluster.df$cluster==2,c(15:17)]))
#check for outliers based on p-value
pvalues <- round(pchisq(mahalanobis.out2, df=3, lower.tail=FALSE),4)
#check for outliers
pvalues<0.001

#calculate distances between points in cluster 3
mahalanobis.out3 <- mahalanobis(manova.cluster.df[manova.cluster.df$cluster==3,c(15:17)],
   colMeans(manova.cluster.df[manova.cluster.df$cluster==3,c(15:17)]),cov(manova.cluster.df[manova.cluster.df$cluster==3,c(15:17)]))
#check for outliers based on p-value
pvalues <- round(pchisq(mahalanobis.out3, df=3, lower.tail=FALSE),4)
#check for outliers
pvalues<0.001

```


MANOVA {data-orientation=rows data-navmenu='Question 2'}
====================
  
Row 1 {data-height=75}
-------------

###

<div align="center"> <h2 align="center"> MANOVA Within Each Cluster </h2> </div>

  
Row 2 {data-height=80}
------------

###

<div align="center"> <h5 align="center"> The tables below show the results of a MANOVA conducted within each cluster on the response variables that fit the assumptions within all three clusters: `SqrtCigarette`, `ObeseChild`, and `PCPAdult`. There are no p-values<0.05 in clusters 1 or 2, indicating no evidence of an association between these health outcomes and any of the amenity variables within those clusters. Two park amenities have a p-value<0.05 in cluster 3, waterfalls and food amenities, indicating a possible relationship between these amenities and health outcomes. </h5> </div> 

Row 3
-----------
  
###
  
<div align="center"> <h3 align="center"> Cluster 1 </h3> </div>
  
```{r cluster1-manova}

#run manova function on cluster 1 for all health variables
manova.cluster1 <- summary(manova.funct(manova.cluster.df[manova.cluster.df$cluster==1,],
                                        c(15:17)))$stats[1:11,]
#capitalize column names
colnames(manova.cluster1) <- c('DF','Pillai','F-statistic','Num DF','Den DF','P-value')
#remove data$ from variables
manova.cluster1[,1] <- gsub(".*\\$", "", rownames(manova.cluster1))
#remove rownmaes
rownames(manova.cluster1) <- NULL
#round
manova.cluster1[,c(2,3,6)] <- round(as.numeric(manova.cluster1[,c(2,3,6)]),4)
#display results
manova.cluster1%>%kable%>%kable_styling(position = "center")

```

###

<div align="center"> <h3 align="center"> Cluster 2 </h3> </div>
  
```{r cluster2-manova}

#create vector to hold dependent variables
dependent.vars <- c()
  #iterate over all columns provided for health variables
for(h.col in 15:17){
  #add each health variable to the dependent.vars variable
  dependent.vars <- cbind(dependent.vars,manova.cluster.df[manova.cluster.df$cluster==2,][,h.col])
}

#create subset of cluster 2
data <- manova.cluster.df[manova.cluster.df$cluster==2,]
#fit MANOVA
fit <- manova(dependent.vars~data$Pets+data$Camping+data$Pavillions+data$Playground+
                  data$Showers+data$watersports+data$Waterfalls+data$food.amenities+
                  data$trails+data$snow.sports+data$hunting.fishing+
                  data$info.center,data=data)
#save results
manova.cluster2 <- summary(fit)$stats[1:5,]
  
#capitalize column names
colnames(manova.cluster2) <- c('DF','Pillai','F-statistic','Num DF','Den DF','P-value')
#remove data$ from variables
manova.cluster2[,1] <- gsub(".*\\$", "", rownames(manova.cluster2))
#remove rownmaes
rownames(manova.cluster2) <- NULL
#round
manova.cluster2[,c(2,3,6)] <- round(as.numeric(manova.cluster2[,c(2,3,6)]),4)
#display results
manova.cluster2%>%kable%>%kable_styling(position = "center")

```


###

<div align="center"> <h3 align="center"> Cluster 3 </h3> </div>
  
```{r cluster3-manova}

#run manova function on cluster 2 for all health variables
manova.cluster3 <- summary(manova.funct(manova.cluster.df[manova.cluster.df$cluster==3,],
                                        c(15:17)))$stats[1:11,]
#capitalize column names
colnames(manova.cluster3) <- c('DF','Pillai','F-statistic','Num DF','Den DF','P-value')
#remove data$ from variables
manova.cluster3[,1] <- gsub(".*\\$", "", rownames(manova.cluster3))
#remove rownames
rownames(manova.cluster3) <- NULL
#round
manova.cluster3[,c(2,3,6)] <- format(round(as.numeric(manova.cluster3[,c(2,3,6)]),4),scientific=F)
#display results
manova.cluster3%>%kable%>%kable_styling(position = "center")%>%row_spec(c(7,8),background='yellow')

```






MANOVA Coefficients {data-orientation=rows data-navmenu='Question 2'}
====================

Row 1
----------

### {data-width=330}

<br />
<br />
  

<div align="center"> <h3 align="center"> MANOVA Coefficients </h3> </div>


<div align="center"> <h5 align="center"> The table to the right shows the coefficients of the MANOVA for each of the predictor variables that were found to be significant. The coefficients  explain the difference in the expected mean of each health outcome when that variable is present versus when that variable is not present. For example, based on these results, it would be expected that the mean prevalence of child obesity for a county in cluster 1 where waterfalls are present is about 0.839% less than a county in cluster 1 where waterfalls are not present. </h5> </div>

### 

<br />
<br />
<br /> 
  
```{r manova-coeffs}

#create vectors of dependent variables
#cluster 1
cluster1 <- manova.cluster.df[manova.cluster.df$cluster==1,]
dependent.vars1 <- cbind(cluster1$SqrtCigarette,cluster1$ObeseChild,cluster1$PCPAdult)
#cluster 2
cluster2 <- manova.cluster.df[manova.cluster.df$cluster==2,]
dependent.vars2 <- cbind(cluster2$SqrtCigarette,cluster2$ObeseChild,cluster2$PCPAdult)
#cluster 3
cluster3 <- manova.cluster.df[manova.cluster.df$cluster==3,]
dependent.vars3 <- cbind(cluster3$SqrtCigarette,cluster3$ObeseChild,cluster3$PCPAdult)


#get coefficients for cluster 1 with just significant variables
cluster1coef <- manova(dependent.vars1~cluster1$Waterfalls+
                  cluster1$food.amenities,data=cluster1)$coefficients
#get coefficients for cluster 2 with just significant variables
cluster2coef <- manova(dependent.vars2~cluster2$Waterfalls+
                  cluster2$food.amenities,data=cluster2)$coefficients
#get coefficients for cluster 3 with just significant variables
cluster3coef <- manova(dependent.vars3~cluster3$Waterfalls+
                  cluster3$food.amenities,data=cluster3)$coefficients

#create vectors of cluster 1
cluster1.water <- c('Cluster 1','Waterfalls',0.145,-0.839,2.155)
cluster1.food <- c('','Food',-0.130,-1.261,-5.375)
#create vectors of cluster 2
cluster2.water <- c('Cluster 2','Waterfalls',1.068,-3.200,4.233)
cluster2.food <- c('','Food',-0.164,-0.220,4.627)
#create vectors of cluster 3
cluster3.water <- c('Cluster 3','Waterfalls',-0.054,-1.817,-2.395)
cluster3.food <- c('','Food',0.0623,0.0626,-1.306)
#create vector of health outcomes
HealthOutcome=c('','','Square Root-Transformed Cigarette Usage','Child Obesity','Adults with Regular Healthcare Provider')

#combine results
results <- as.data.frame(rbind(HealthOutcome,cluster1.water,cluster1.food,cluster2.water,cluster2.food,cluster3.water,cluster3.food))
#remove row names
rownames(results) <- NULL
#remove col names
colnames(results) <- NULL
#show results
results%>%kable(align='c')%>%kable_styling(position = "center")%>%row_spec(1,bold=T)%>%column_spec(c(1,2),bold=T)

```

Row 2
-----------

### {data-width=330}

<br />
<br />

<div align="center"> <h3 align="center"> MANOVA Coefficients Back-Transformed </h3> </div>


<div align="center"> <h5 align="center"> Because cigarette usage was square root-transformed, a back-transformation must be done in order to interpret the coefficients on the original scale. The table below shows each step done in the back-transformations. The first two columns specify the cluster and amenity variable. The third column displays raw mean cigarette usage in each cluster. The fourth column is the square root of these means. The next column adds the MANOVA coefficients to the square root-transformed means. The new square root-transformed mean is shown and then back-transformed to the original scale by squaring it. The new mean on the original scale is shown, along with the difference in the original raw mean and the new back-transformed mean. </h5> </div> 

###

<br />
<br />
<br /> 
  
```{r back-transform table}

#clusters column
clusters <- c('1','','2','','3','')
#amenities column
amenities <- c(rep(c('Waterfalls','Food'),3))
#step 1 column
rawmeans <- c(paste(round(mean(
  cluster1[cluster1$Waterfalls==0,]$SqrtCigarette)^2,2),'%',sep=''),paste(
  round(mean(
  cluster1[cluster1$food.amenities==0,]$SqrtCigarette)^2,2),'%',sep=''),paste(
  round(mean(
  cluster2[cluster2$Waterfalls==0,]$SqrtCigarette)^2,2),'%',sep=''),paste(
  round(mean(
  cluster2[cluster2$food.amenities==0,]$SqrtCigarette)^2,2),'%',sep=''),paste(
  round(mean(
  cluster3[cluster3$Waterfalls==0,]$SqrtCigarette)^2,2),'%',sep=''),paste(
  round(mean(
  cluster3[cluster3$food.amenities==0,]$SqrtCigarette)^2,2),'%',sep=''))


#step 2
sqrtmeans <- round(sqrt(as.numeric(str_sub(rawmeans,end = -2))),2)
#coeffs
coeffs <- c(0.15,-0.13,1.07,-0.16,-0.05,0.06)
#step 3
sqrtmeancoeff <- c(sqrtmeans+coeffs)
#step 4
backtransform <- paste(round(sqrtmeancoeff^2,2),'%',sep='')
#difference column
diff <- paste(round(as.numeric(str_sub(backtransform,end = -2))-as.numeric(str_sub(rawmeans,end = -2)),2),'%',sep='')
#vector of plus signs
plus.vec <- c('$+$','$+$','$+$','$+$','$+$','$+$')
#vector of equal signs
equal.vec <- c('=','=','=','=','=','=')
#vector of squares
square.vec <- c(' =',' =',' =',' =',' =',' =')
#blank column
blanks <- c(rep('',6))

#save results
res <- cbind(clusters,amenities,rawmeans,sqrtmeans,plus.vec,coeffs,equal.vec,
             sqrtmeancoeff,square.vec,backtransform,blanks,diff)

#change colnames
colnames(res) <- c('Cluster','Amenity','Raw Mean','Mean',
                   '','MANOVA Coefficient','','New Mean','','New Raw Mean','','Difference in Means')


res%>%kable%>%kable_styling(position='center')%>%
  column_spec(c(1,2,5,7),bold=T)%>%
  row_spec(c(1,2),background = '#EBFBFD')%>%
  row_spec(c(3,4),background = '#F0FDEB')%>%
  row_spec(c(5,6),background = '#FDF9EB')%>%
  column_spec(c(3,11,12),background = 'white')%>%
  column_spec(c(1,2,5:7),width='0.6cm')%>%
  column_spec(c(3,4,8),width='2.5cm')%>%
  column_spec(2,width='3cm')%>%
  column_spec(c(5,7),width='0.6cm')%>%
  column_spec(10,width='2.4cm')%>%
  column_spec(9,width='1cm')%>%
  row_spec(c(0:6),align='c')%>%
  column_spec(11,width='1.2cm',border_left=T)%>%
  column_spec(12,width='5cm')%>%
  column_spec(c(2,3),border_right=T)

```




Post-Hoc LDA {data-orientation=rows data-navmenu='Question 2'}
====================


<div align="center"> <h5 align="center"> The Linear Discriminate Analysis (LDA) plots below show the separation or lack thereof between observations with the amenity (shown in teal) and those without (shown in red) within each cluster. Interestingly, there appears to be visible separation among some of the predictor variables that were not identified as statistically significant in the MANOVA, such as pets and hunting/fishing in cluster 2. This could be due to the small number of observations, which can lead to over-fitting with LDA. When there are few observations, LDA can nearly always find a line of separation by chance alone. Cluster 2 has the fewest observations of all three clusters, which is likely contributing to this effect. </h5> </div> 


```{r lda-cluster-input}

#allow user to select an amenity
radioButtons(inputId = "amenity3",
             label = "Please Select an Amenity",
             choices =  colnames(manova.cluster.df)[c(2:14)],
             inline = T)

```

###

```{r lda-c1}

renderPlotly({
  #create subset of data with user choice
  sub1 <- cluster1%>%dplyr::select(input$amenity3,SqrtCigarette,ObeseChild,PCPAdult)
  lda.out1 <- lda(sub1[,1]~dependent.vars1,CV=F,tol=0)
  #save predictions
  lda.df1 <- cbind(IndependentVariable=sub1[,1],lda = predict(lda.out1)$x)
  #create predictions plot
  lda.plot1 <- ggplot(data.frame(lda.df1))+geom_point(aes(x = LD1, y = LD2, color = sub1[,1]), size = 4) +
  theme_classic()+guides(color=guide_legend(title=colnames(sub1)[1]))+
    labs(title='Cluster 1')
  #display the plot
  ggplotly(lda.plot1)
})


```

###

```{r lda-c2}

renderPlotly({
  #create subset of data with user choice
  sub2 <- cluster2%>%dplyr::select(input$amenity3,SqrtCigarette,ObeseChild,PCPAdult)
  lda.out2 <- lda(sub2[,1]~dependent.vars2,CV=F,tol=0)
  #save predictions
  lda.df2 <- cbind(IndependentVariable=sub2[,1],lda = predict(lda.out2)$x)
  #create predictions plot
  lda.plot2 <- ggplot(data.frame(lda.df2))+geom_point(aes(x = LD1, y = LD2, color = sub2[,1]), size = 4) +
    theme_classic()+guides(color=guide_legend(title=colnames(sub2)[1]))+
    labs(title='Cluster 2')
  #display the plot
  ggplotly(lda.plot2)
})

```

###

```{r lda-c3}

renderPlotly({
  #create subset of data with user choice
  sub3 <- cluster3%>%dplyr::select(input$amenity3,SqrtCigarette,ObeseChild,PCPAdult)
  lda.out3 <- lda(sub3[,1]~dependent.vars3,CV=F,tol=0)
  #save predictions
  lda.df3 <- cbind(IndependentVariable=sub3[,1],lda = predict(lda.out3)$x)
  #create predictions plot
  lda.plot3 <- ggplot(data.frame(lda.df3))+geom_point(aes(x = LD1, y = LD2, color = sub3[,1]), size = 4) +
    theme_classic()+guides(color=guide_legend(title=colnames(sub3)[1]))+
    labs(title='Cluster 3')
  #display the plot
  ggplotly(lda.plot3)
})

```


Nonparametric ANOVA {data-orientation=rows data-navmenu='Question 2'}
====================
  
Row 1 {data-height=100}
------------
  
<div align="center"> <h3 align="center"> The tables below show the results of a nonparametric (rank-based) ANOVA of overall health rating within each cluster. Yellow rows indicate statistically significant evidence of a difference in mean.  </h3> </div>
  
Row 2
------------
  
###
  
<div align="center"> <h3 align="center"> Cluster 1 </h3> </div>
  
  
```{r npanova1}

#subset the data
cluster1$HealthRating <- manova.df[manova.cluster.df$cluster==1,]$HealthRating

#run npanova in cluster 1
cluster1npanova <- aov(rank(HealthRating)~Pets+Camping+Pavillions+Playground+Showers+Waterfalls+
                         watersports+food.amenities+trails+field.sports+snow.sports+hunting.fishing+
                         info.center,data=cluster1)

#display results
round(data.frame(unclass(summary(cluster1npanova)), check.names = FALSE, stringsAsFactors = FALSE)[1:11,],3)%>%kable%>%kable_styling(position = "center")%>%row_spec(10, background  = "yellow")

```


### {data-height=800}

<div align="center"> <h3 align="center"> Cluster 2 </h3> </div>
  
```{r npanova2}

#subset the data
cluster2$HealthRating <- manova.df[manova.cluster.df$cluster==2,]$HealthRating

#run npanova in cluster 2
cluster2npanova <- aov(rank(HealthRating)~Pets+Camping+Pavillions+Playground+Showers+Waterfalls+
                         watersports+food.amenities+trails+field.sports+snow.sports+hunting.fishing+
                         info.center,data=cluster2)
#display results
round(data.frame(unclass(summary(cluster2npanova)), check.names = FALSE, stringsAsFactors = FALSE)[1:6,],3)%>%kable%>%kable_styling(position = "center")

```

###

<div align="center"> <h3 align="center"> Cluster 3 </h3> </div>
  
```{r npanova3}

#subset the data
cluster3$HealthRating <- manova.df[manova.cluster.df$cluster==3,]$HealthRating

#run npanova in cluster 3
cluster3npanova <- aov(rank(HealthRating)~Pets+Camping+Pavillions+Playground+Showers+Waterfalls+
                         watersports+food.amenities+trails+field.sports+snow.sports+hunting.fishing+
                         info.center,data=cluster3)
#display results
round(data.frame(unclass(summary(cluster3npanova)), check.names = FALSE, stringsAsFactors = FALSE)[1:11,],3)%>%kable%>%kable_styling(position = "center")

```

Row 3 {data-height=100}
--------------
  
<div align="center"> <h3 align="center"> The tables below show the results of a Tukey-Kramer contrast of the ANOVA results above. There are no p-values<0.05 when the family-wise error rate is controlled. The estimated difference for cluster 3 is 0, and the p-value is 1. This is likely due to the nearly equivalent mean health rating at each level of snow sports for cluster 3, shown below. </h3> </div>
  
Row 4
------------
  
###
  
```{r cluster1-tukey}

#create tukey-kramer function
tukey.funct <- function(cluster){
  #create anova with only snow sports
  posthoc <- aov(rank(HealthRating)~snow.sports,
                 data=manova.cluster.df[manova.cluster.df$cluster==cluster,])
  #tukey-kramer
  results <- TukeyHSD(posthoc)
  diff <- round(results[[1]][1],3)
  lo <- round(results[[1]][2],3)
  hi <- round(results[[1]][3],3)
  p <- round(results[[1]][4],2)
  
  #create dataframe of results
  res <- as.data.frame(cbind(Amenity='Snow Sports',Difference=diff,
                      LowCI=lo,HighCI=hi,Pvalue=p))
  #display results
  res%>%kable%>%kable_styling(position = "center")%>%column_spec(5,bold=T,color='red')

}

#run function on cluster 1
tukey.funct(1)

```


###

```{r cluster2-tukey}

#run function on cluster 1
tukey.funct(2)

```

###

```{r cluster3-tukey}

#cluster 3 function
tukey.funct(3)
#difference in means at each group
cat('Mean overall health rating in cluster 3 when snow sports are not available: ',
    round(mean(cluster3[cluster3$snow.sports==0,]$HealthRating),3),
'\nMean overall health rating in cluster 3 when snow sports are available: ',
    round(mean(cluster3[cluster3$snow.sports==1,]$HealthRating),3))

```



Question 2 Conclusion {data-orientation=rows data-navmenu='Question 2'}
============
  


<br />
<br />

<div align="center"> <h1 align="center"> **Question 2 Conclusion:** </h1> </div>
  
<br />

<div align="center"> <h3 align="center"> **Question 2:	Does the relationship vary between groups of counties with different ranges of health outcomes and, if so, what is the magnitude and direction of the relationship(s) within each group?** </h3> </div>

  
<div align="center"> <h4 align="center"> The only individual health outcomes that met the assumptions of MANOVA and could be assessed were square-root transformed cigarette usage, childhood obesity, and adults with a regular healthcare provider. The only park amenities that had a statistically significant relationship with these health outcomes were waterfalls and food amenities in cluster 3 (p-value=0.0002 and p-value=0.04, respectively).  \
<br />
When waterfalls are present in state parks within counties in clusters 1 and 2, a decrease can be seen in the percentage of adults who smoke cigarettes. However, the presence of food amenities within these counties is associated with an increase in this statistic. Child obesity decreases in all clusters when waterfalls are present and in clusters 1 and 2 when food amenities are present. The percentage of adults with a regular healthcare provider increases for counties in clusters 1 and 2 when waterfalls are present but decreases in cluster 3 when either waterfalls or food amenities are present.   \
<br />
No statistically significant evidence of an association between overall health rating and any of the park amenities was found when the family-wise error rate was controlled for.

</h4> </div>
  
  
Overall Conclusions {data-orientation=columns}
===============
  

###
  
<br />
<br />
<br />
<br />
<br />
<br />
<br />

* **Study Results**:
  + When all counties are considered:
    + Possible positive association between all health outcomes and playgrounds
    + Possible positive association between overall health rating and trails
    
  + When counties are clustered:
    + MANOVA Results:
      + Waterfalls:
        + Cigarette usage decreases in clusters 1 and 2.
        + Child obesity decreases in all clusters.
        + Adults with a regular healthcare provider increases in clusters 1 and 2.
      + Food Amenities:
        + Cigarette usage decreases in cluster 3 but increases in clusters 1 and 2.
        + Child obesity decreases in clusters 1 and 2 but increases slightly in cluster 3. 
        + Adults with a regular healthcare provider decreases in clusters 1 and 3 but increases in cluster 2.
    + Nonparametric ANOVA Results:
      + No evidence of association

* **Implications**:
  + Research possible associations between:
    + Trails and overall health rating.
    + Waterfalls and cigarette usage.
    + Waterfalls and child obesity
    + Food amenities and child obesity.
  + Consider confounding factors.
  + Retest with a larger sample size.

